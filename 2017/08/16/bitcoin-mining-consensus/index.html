<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>比特币的挖矿与共识 - 凯凯刘</title>
  <meta name="author" content="凯凯刘">
  
  <meta name="description" content="很多人知道比特币，区块链。但是整个网络是怎么保证这个去中心化的？可能很多人并不了解，或者说想了解但是不知道从何入手。其实从挖矿这个角度去理解区块链会更能抓住重点，了解了挖矿，你就了解了区块链，了解了去中心化">
  
  <meta name="keywords" content="比特币,区块链,挖矿,区块链分叉,独立验证,工作量证明算法">
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="比特币的挖矿与共识"/>
  <meta property="og:site_name" content="凯凯刘"/>

  
    <meta property="og:image" content="/img/300L.png"/>
  

  <meta name="google-site-verification" content="iIzqxT8FAfRGM8f4sr97VvjhDsk3QJQ-a2LMdn0DtXU" />

  <link href="/favicon.png" rel="icon">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="alternate" href="/atom.xml" title="凯凯刘" type="application/atom+xml">
  <link rel="stylesheet" href="/css/styleNew.css?x=6" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/gitment.css">
  <script src="/js/qrcode.min.js"></script>

  <!--<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>-->
  <!--<script>-->
      <!--(adsbygoogle = window.adsbygoogle || []).push({-->
          <!--google_ad_client: "ca-pub-3023100525130189",-->
          <!--enable_page_level_ads: true-->
      <!--});-->
  <!--</script>-->
</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
    <h1><a href="/">凯凯刘</a></h1>
    <h2><a href="/">
            
            Indie Maker、认知、技术、变现
            
        </a></h2>
</div>
<nav id="main-nav" class="alignright">
    <ul>
        
        <li><a href="/" onclick="ga('send', 'event', 'nav_top', '首页');">首页</a></li>
        
        <li><a href="/categories/Web技术/" onclick="ga('send', 'event', 'nav_top', 'Web技术');">Web技术</a></li>
        
        <li><a href="/categories/浏览器扩展插件/" onclick="ga('send', 'event', 'nav_top', '浏览器扩展插件');">浏览器扩展插件</a></li>
        
        <li><a href="/categories/区块链/" onclick="ga('send', 'event', 'nav_top', '区块链');">区块链</a></li>
        
        <li><a href="/categories/%E8%AE%A4%E7%9F%A5/" onclick="ga('send', 'event', 'nav_top', '认知');">认知</a></li>
        
        <li><a href="/categories/%E8%AF%BB%E4%B9%A6/" onclick="ga('send', 'event', 'nav_top', '读书');">读书</a></li>
        
        <li><a href="/categories/%E6%B5%81%E9%87%8F/" onclick="ga('send', 'event', 'nav_top', '流量');">流量</a></li>
        
        <li><a href="/categories/%E5%8F%98%E7%8E%B0/" onclick="ga('send', 'event', 'nav_top', '变现');">变现</a></li>
        
        <li><a href="/categories/%E7%94%9F%E6%B4%BB/" onclick="ga('send', 'event', 'nav_top', '生活');">生活</a></li>
        
        <li><a href="/2015/03/01/link-friends/" onclick="ga('send', 'event', 'nav_top', '友链');">友链</a></li>
        
        <li><a href="/2015/02/28/new/" onclick="ga('send', 'event', 'nav_top', '关于');">关于</a></li>
        
        <li><a href="/atom.xml" class="menu_rss" target="_blank" title="RSS订阅"></a></li>
    </ul>
    <div class="clearfix"></div>
    <!--<div class="nav_zhibo" style="position: absolute;top : 120px;left: 40px;color: blue;">-->
        <!--<a style="color: blue;cursor: pointer;" href="https://m.qlchat.com/topic/360000033244498.htm?preview=Y&intoPreview=Y"-->
           <!--onclick="ga('send', 'event', 'nav_zhibo', 'qianliao');"-->
           <!--target="_blank">我的千聊直播(周三)：比特币的挖矿与共识-->
        <!--</a>-->
    <!--</div>-->

</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft">

      <div class="ads_banner">
        <!--<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>-->
        <!-- banner -->
        <!--<ins class="adsbygoogle"-->
             <!--style="display:block"-->
             <!--data-ad-client="ca-pub-4018032316880050"-->
             <!--data-ad-slot="3550377487"-->
             <!--data-ad-format="auto"></ins>-->
        <!--<script>-->
          <!--(adsbygoogle = window.adsbygoogle || []).push({});-->
        <!--</script>-->

        <!-- <div>
          <a href="https://t.zsxq.com/ybIuBaA" target="_blank">
            <img style="width: 100%" src="http://qiniu.gafata.com/2019-06-11-indiemaker_dlbx_1800x180.jpg?imageView2/2/w/1800"/>
          </a>
        </div> -->

        <div class="banner-top" style="background-color: #032535;color:white;padding: 15px;font-size: 15px;">
          「每日看板-Tabhub」浏览器新标签页，独立变现、新闻、日历、待办、RSS、股票等丰富组件
          <a href="https://www.tabhub.app/?utm_source=blog" target="_blank" style="word-break: break-all;background-color:#c2007c;margin-left:10px;display:inline-block;width: 70px;padding:4px 4px;border-radius: 4px;color:white;text-align: center;" 
          onclick="ga('send', 'event', 'ads', 'tabhub');" >免费使用</a>
          <!--星云开发者开放注册啦，提交一个DApp即可获得100个NAS(大约7000元）,更有周、月度大额奖金等你拿！开发者今年最大的机会, 会JavaScript即可。<br>-->
          <!--注册链接：<a target="_blank" style="word-break: break-all;" onclick="ga('send', 'event', 'ads', 'nebulas');" href="https://incentive.nebulas.io/cn/signup.html?invite=HjuhT">https://incentive.nebulas.io/cn/signup.html?invite=HjuhT</a>-->
          <!--<span style="color: red">阿里云双11红包来啦，拼购1折起, 官方推荐1折团！</span><a href="https://m.aliyun.com/act/team1111/#/share?params=N.qYnY8sp2fK.kkb39ote" target="_blank" style="" onclick="ga('send', 'event', 'ads', 'aliyun');">马上参团>></a>-->

        </div>
      </div>

      <div id="wrapper">
    
    <div style="display: none">
        <img src="/img/300L.png" />
    </div>



<article class="post">
  
  <div class="post-content">
    <header>
      
  
    <h1 class="title">比特币的挖矿与共识</h1>
  

      
        <div class="icon"></div>
        <div class="article_head_extend">
          <time datetime="2017-08-16T14:22:15.000Z"><a href="/2017/08/16/bitcoin-mining-consensus/">Aug 16 2017</a>
            
          </time>
          <div class="qrcode_con">
            <div class="qrcode_text">扫描二维码</div>
            <div id="Wed Aug 16 2017 22:22:15 GMT+0800 (China Standard Time)" class="qrcode_img"></div>
            <script>
              var qrcode = new QRCode(document.getElementById("Wed Aug 16 2017 22:22:15 GMT+0800 (China Standard Time)"), {
                width : 100,
                height : 100
              });
              qrcode.makeCode("http://liujinkai.com//2017/08/16/bitcoin-mining-consensus/?utm_medium=blog&utm_source=qrcode");
            </script>
          </div>
        </div>

      
    </header>
    <div></div>
    <div class="entry">
      
        <p>很多人知道比特币，区块链。但是整个网络是怎么保证这个去中心化的？可能很多人并不了解，或者说想了解但是不知道从何入手。其实从挖矿这个角度去理解区块链会更能抓住重点，了解了挖矿，你就了解了区块链，了解了去中心化。</p>
<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p><img src="http://qiniu.gafata.com/2017-08-04-timg.jpeg?imageView2/2/w/800" alt=""></p>
<a id="more"></a>
<p>可以将区块链看作一本记录所有交易的公开总帐簿（列表），比特币网络中的每个参与者都把它看作一本所有权的权威记录。</p>
<p>比特币没有中心机构，几乎所有的完整节点都有一份公共总帐的备份，这份总帐可以被视为认证过的记录。</p>
<p>至今为止，在主干区块链上，没有发生一起成功的攻击，一次都没有。</p>
<p>通过创造出新区块，比特币以一个确定的但不断减慢的速率被铸造出来。大约每十分钟产生一个新区块，每一个新区块都伴随着一定数量从无到有的全新比特币。每开采210,000个块，大约耗时4年，货币发行速率降低50%。</p>
<p><img src="http://qiniu.gafata.com/2017-08-03-162858.jpg?imageView2/2/w/800" alt=""></p>
<p>在2016年的某个时刻，在第420,000个区块被“挖掘”出来之后降低到12.5比特币/区块。在第13,230,000个区块（大概在2137年被挖出）之前，新币的发行速度会以指数形式进行64次“二等分”。到那时每区块发行比特币数量变为比特币的最小货币单位——1聪。最终，在经过1,344万个区块之后，所有的共20,999,999.9769聪比特币将全部发行完毕。换句话说，<strong>到2140年左右，会存在接近2,100万比特币。在那之后，新的区块不再包含比特币奖励，矿工的收益全部来自交易费。</strong></p>
<p><img src="http://qiniu.gafata.com/2017-08-04-%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-08-04%20%E4%B8%8A%E5%8D%888.52.22.png?imageView2/2/w/800" alt=""></p>
<p>比特币的去中心化共识由所有网络节点的<strong>4种独立过程</strong>相互作用而产生：</p>
<ul>
<li>每个全节点依据综合标准对每个交易进行独立验证</li>
<li>通过完成工作量证明算法的验算，挖矿节点将交易记录独立打包进新区块，</li>
<li>每个节点独立的对新区块进行校验并组装进区块链</li>
<li>每个节点对区块链进行独立选择，在工作量证明机制下选择累计工作量最大的区块链</li>
</ul>
<h1 id="1、独立验证"><a href="#1、独立验证" class="headerlink" title="1、独立验证"></a>1、独立验证</h1><p>在收到交易后，每一个节点都会在全网广播前对这些交易进行校验，并以接收时的相应顺序，为有效的新交易建立一个池（交易池）。</p>
<p>每一个节点在校验每一笔交易时，都需要对照一个长长的标准列表：</p>
<blockquote>
<p>▷交易的语法和数据结构必须正确。<br>▷输入与输出列表都不能为空。<br>▷交易的字节大小是小于MAX_BLOCK_SIZE的。<br>▷每一个输出值，以及总量，必须在规定值的范围内 （小于2,100万个币，大于0）。<br>▷没有哈希等于0，N等于-1的输入（coinbase交易不应当被中继）。<br>▷nLockTime是小于或等于INT_MAX的。<br>▷交易的字节大小是大于或等于100的。<br>▷交易中的签名数量应小于签名操作数量上限。<br>▷解锁脚本（scriptSig）只能够将数字压入栈中，并且锁定脚本（scriptPubkey）必须要符合isStandard的格式 （该格式将会拒绝非标准交易）。<br>▷池中或位于主分支区块中的一个匹配交易必须是存在的。<br>▷对于每一个输入，如果引用的输出存在于池中任何的交易，该交易将被拒绝。<br>▷对于每一个输入，在主分支和交易池中寻找引用的输出交易。如果输出交易缺少任何一个输入，该交易将成为一个孤立的交易。如果与其匹配的交易还没有出现在池中，那么将被加入到孤立交易池中。<br>▷对于每一个输入，如果引用的输出交易是一个coinbase输出，该输入必须至少获得COINBASE_MATURITY (100)个确认。<br>▷对于每一个输入，引用的输出是必须存在的，并且没有被花费。<br>▷使用引用的输出交易获得输入值，并检查每一个输入值和总值是否在规定值的范围内 （小于2100万个币，大于0）。<br>▷如果输入值的总和小于输出值的总和，交易将被中止。<br>▷如果交易费用太低以至于无法进入一个空的区块，交易将被拒绝。<br>▷每一个输入的解锁脚本必须依据相应输出的锁定脚本来验证。</p>
</blockquote>
<h1 id="2、将交易记录独立打包进新区块"><a href="#2、将交易记录独立打包进新区块" class="headerlink" title="2、将交易记录独立打包进新区块"></a>2、将交易记录独立打包进新区块</h1><p>以下挖矿节点取名为<strong>A挖矿节点</strong><br>挖矿节点时刻监听着传播到比特币网络的新区块。而这些新加入的区块对挖矿节点有着特殊的意义。矿工间的竞争以新区块的传播而结束，如同宣布谁是最后的赢家。对于矿工们来说，获得一个新区块意味着某个参与者赢了，而他们则输了这场竞争。然而，一轮竞争的结束也代表着下一轮竞争的开始。</p>
<p><strong>验证交易后，比特币节点会将这些交易添加到自己的内存池中。内存池也称作交易池，用来暂存尚未被加入到区块的交易记录。</strong></p>
<h2 id="2-1-交易块龄，矿工费和优先级"><a href="#2-1-交易块龄，矿工费和优先级" class="headerlink" title="2.1 交易块龄，矿工费和优先级"></a>2.1 交易块龄，矿工费和优先级</h2><p><img src="http://qiniu.gafata.com/2017-08-03-161758.jpg?imageView2/2/w/600" alt=""><br>A节点需要为内存池中的每笔交易分配一个优先级，并选择较高优先级的交易记录来构建候选区块。<br>一个交易想要成为“较高优先级”，需满足的条件：优先值大于57,600,000，这个值的生成依赖于3个参数：一个比特币（即1亿聪），年龄为一天（144个区块），交易的大小为250个字节：</p>
<blockquote>
<p>High Priority > 100,000,000 satoshis * 144 blocks / 250 bytes = 57,600,000</p>
</blockquote>
<p><strong>区块中用来存储交易的前50K字节是保留给较高优先级交易的。</strong>节点在填充这50K字节的时候，会优先考虑这些最高优先级的交易，不管它们是否包含了矿工费。这种机制使得高优先级交易即便是零矿工费，也可以优先被处理。</p>
<p>然后，A挖矿节点会选出那些包含最小矿工费的交易，并按照“每千字节矿工费”进行排序，优先选择矿工费高的交易来填充剩下的区块。</p>
<p>如区块中仍有剩余空间，A挖矿节点可以选择那些不含矿工费的交易。有些矿工会竭尽全力将那些不含矿工费的交易整合到区块中，而其他矿工也许会选择忽略这些交易。</p>
<p>在区块被填满后，内存池中的剩余交易会成为下一个区块的候选交易。因为这些交易还留在内存池中，所以随着新的区块被加到链上，这些交易输入时所引用UTXO的深度（即交易“块龄”）也会随着变大。由于交易的优先值取决于它交易输入的“块龄”，所以这个交易的优先值也就随之增长了。最后，一个零矿工费交易的优先值就有可能会满足高优先级的门槛，被免费地打包进区块。</p>
<blockquote>
<p>UTXO（Unspent Transaction Output） : 每笔交易都有若干交易输入，也就是资金来源，也都有若干笔交易输出，也就是资金去向。一般来说，每一笔交易都要花费（spend）一笔输入，产生一笔输出，而其所产生的输出，就是“未花费过的交易输出”，也就是 UTXO。<br>块龄：UTXO的“块龄”是自该UTXO被记录到区块链为止所经历过的区块数，即这个UTXO在区块链中的深度。</p>
</blockquote>
<h2 id="2-2-创币交易"><a href="#2-2-创币交易" class="headerlink" title="2.2 创币交易"></a>2.2 创币交易</h2><p>区块中的第一笔交易是笔特殊交易，称为创币交易或者coinbase交易。这个交易是由挖矿节点构造并用来奖励矿工们所做的贡献的。假设此时一个区块的奖励是25比特币，A挖矿的节点会创建“向A的地址支付25.1个比特币(包含矿工费0.1个比特币)”这样一个交易，把生成交易的奖励发送到自己的钱包。A挖出区块获得的奖励金额是coinbase奖励（25个全新的比特币）和区块中全部交易矿工费的总和。</p>
<h1 id="3-构造区块"><a href="#3-构造区块" class="headerlink" title="3 构造区块"></a>3 构造区块</h1><p>A节点已经构建了一个候选区块，那么就轮到A的矿机对这个新区块进行“挖掘”，求解工作量证明算法以使这个区块有效。比特币挖矿过程使用的是SHA256哈希函数。<br>用最简单的术语来说，<strong>挖矿节点不断重复进行尝试，直到它找到的随机调整数使得产生的哈希值低于某个特定的目标。</strong>哈希函数的结果无法提前得知，也没有能得到一个特定哈希值的模式。举个例子，你一个人在屋里打台球，白球从A点到达B点，但是一个人推门进来看到白球在B点，却无论如何是不知道如何从A到B的。哈希函数的这个特性意味着：得到哈希值的唯一方法是不断的尝试，每次随机修改输入，直到出现适当的哈希值。</p>
<p>需要以下参数<br>• block的版本 version<br>• 上一个block的hash值: prev_hash<br>• 需要写入的交易记录的hash树的值: merkle_root<br>• 更新时间: ntime<br>• 当前难度: nbits<br>挖矿的过程就是找到x使得</p>
<blockquote>
<p>SHA256(SHA256(version + prev_hash + merkle_root + ntime + nbits + x )) \&lt; TARGET</p>
</blockquote>
<p>上式的x的范围是0~2^32, TARGET可以根据当前难度求出的。</p>
<p>简单打个比方，想象人们不断扔一对色子以得到小于一个特定点数的游戏。第一局，目标是12。只要你不扔出两个6，你就会赢。然后下一局目标为11。玩家只能扔10或更小的点数才能赢，不过也很简单。假如几局之后目标降低为了5。现在有一半机率以上扔出来的色子加起来点数会超过5，因此无效。随着目标越来越小，要想赢的话，扔色子的次数会指数级的上升。最终当目标为2时（最小可能点数），只有一个人平均扔36次或2%扔的次数中，他才能赢。</p>
<h2 id="3-1-难度的调整"><a href="#3-1-难度的调整" class="headerlink" title="3.1 难度的调整"></a>3.1 难度的调整</h2><p>如前所述，目标决定了难度，进而影响求解工作量证明算法所需要的时间。那么问题来了：为什么这个难度值是可调整的？由谁来调整？如何调整？</p>
<p>比特币的区块平均每10分钟生成一个。这就是比特币的心跳，是货币发行速率和交易达成速度的基础。不仅是在短期内，而是在几十年内它都必须要保持恒定。在此期间，计算机性能将飞速提升。此外，参与挖矿的人和计算机也会不断变化。为了能让新区块的保持10分钟一个的产生速率，挖矿的难度必须根据这些变化进行调整。事实上，难度是一个动态的参数，会定期调整以达到每10分钟一个新区块的目标。简单地说，难度被设定在，无论挖矿能力如何，新区块产生速率都保持在10分钟一个。</p>
<p>那么，在一个完全去中心化的网络中，这样的调整是如何做到的呢？难度的调整是在每个完整节点中独立自动发生的。每2,016个区块(2周产生的区块)中的所有节点都会调整难度。难度的调整公式是由最新2,016个区块的花费时长与20,160分钟（两周，即这些区块以10分钟一个速率所期望花费的时长）比较得出的。难度是根据实际时长与期望时长的比值进行相应调整的（或变难或变易）。简单来说，如果网络发现区块产生速率比10分钟要快时会增加难度。如果发现比10分钟慢时则降低难度。</p>
<p>为了防止难度的变化过快，每个周期的调整幅度必须小于一个因子（值为4）。如果要调整的幅度大于4倍，则按4倍调整。由于在下一个2,016区块的周期不平衡的情况会继续存在，所以进一步的难度调整会在下一周期进行。因此平衡哈希计算能力和难度的巨大差异有可能需要花费几个2,016区块周期才会完成。</p>
<h2 id="3-2-成功构建区块"><a href="#3-2-成功构建区块" class="headerlink" title="3.2 成功构建区块"></a>3.2 成功构建区块</h2><p>举个例子，当前A节点在挖277,316个区块，A挖矿节点一旦完成计算，立刻将这个区块发给它的所有相邻节点。这些节点在接收并验证这个新区块后，也会继续传播此区块。当这个新区块在网络中扩散时，每个节点都会将它作为第277,316个区块(父区块为277,315)加到自身节点的区块链副本中。当挖矿节点收到并验证了这个新区块后，它们会放弃之前对构建这个相同高度区块的计算，并立即开始计算区块链中下一个区块的工作。</p>
<h2 id="3-3-校验新区块"><a href="#3-3-校验新区块" class="headerlink" title="3.3 校验新区块"></a>3.3 校验新区块</h2><p>比特币共识机制的第三步是通过网络中的每个节点独立校验每个新区块。当新区块在网络中传播时，每一个节点在将它转发到其节点之前，会进行一系列的测试去验证它。这确保了只有有效的区块会在网络中传播。</p>
<p>每一个节点对每一个新区块的独立校验，确保了矿工无法欺诈。在前面的章节中，我们看到了矿工们如何去记录一笔交易，以获得在此区块中创造的新比特币和交易费。为什么矿工不为他们自己记录一笔交易去获得数以千计的比特币？这是因为每一个节点根据相同的规则对区块进行校验。一个无效的coinbase交易将使整个区块无效，这将导致该区块被拒绝，因此，该交易就不会成为总账的一部分。</p>
<h1 id="4、区块链的组装与选择"><a href="#4、区块链的组装与选择" class="headerlink" title="4、区块链的组装与选择"></a>4、区块链的组装与选择</h1><p>比特币去中心化的共识机制的最后一步是将区块集合至有最大工作量证明的链中。一旦一个节点验证了一个新的区块，它将尝试将新的区块连接到到现存的区块链，将它们组装起来。</p>
<p>节点维护三种区块：</p>
<ul>
<li>第一种是连接到主链上的，</li>
<li>第二种是从主链上产生分支的（备用链），</li>
<li>第三种是在已知链中没有找到已知父区块的。</li>
</ul>
<p>有时候，新区块所延长的区块链并不是主链，这一点我们将在下面“ 区块链分叉”中看到。</p>
<p>如果节点收到了一个有效的区块，而在现有的区块链中却未找到它的父区块，那么这个区块被认为是“孤块”。孤块会被保存在孤块池中，直到它们的父区块被节点收到。一旦收到了父区块并且将其连接到现有区块链上，节点就会将孤块从孤块池中取出，并且连接到它的父区块，让它作为区块链的一部分。当两个区块在很短的时间间隔内被挖出来，节点有可能会以相反的顺序接收到它们，这个时候孤块现象就会出现。</p>
<p>选择了最大难度的区块链后，所有的节点最终在全网范围内达成共识。随着更多的工作量证明被添加到链中，链的暂时性差异最终会得到解决。挖矿节点通过“投票”来选择它们想要延长的区块链，当它们挖出一个新块并且延长了一个链，新块本身就代表它们的投票。</p>
<h2 id="4-1-区块链分叉"><a href="#4-1-区块链分叉" class="headerlink" title="4.1 区块链分叉"></a>4.1 区块链分叉</h2><p>因为区块链是去中心化的数据结构，所以不同副本之间不能总是保持一致。区块有可能在不同时间到达不同节点，导致节点有不同的区块链视角。解决的办法是，<strong>每一个节点总是选择并尝试延长代表累计了最大工作量证明的区块链，也就是最长的或最大累计难度的链。</strong></p>
<p>当有两个候选区块同时想要延长最长区块链时，分叉事件就会发生。正常情况下，分叉发生在两名矿工在较短的时间内，各自都算得了工作量证明解的时候。两个矿工在各自的候选区块一发现解，便立即传播自己的“获胜”区块到网络中，先是传播给邻近的节点而后传播到整个网络。每个收到有效区块的节点都会将其并入并延长区块链。如果该节点在随后又收到了另一个候选区块，而这个区块又拥有同样父区块，那么节点会将这个区块连接到候选链上。其结果是，一些节点收到了一个候选区块，而另一些节点收到了另一个候选区块，这时两个不同版本的区块链就出现了。</p>
<p><strong>分叉之前</strong><br><img src="http://qiniu.gafata.com/2017-08-03-160507.jpg?imageView2/2/w/800" alt=""></p>
<p><strong>分叉开始</strong><br><img src="http://qiniu.gafata.com/2017-08-03-160627.jpg?imageView2/2/w/800" alt=""><br>我们看到两个矿工几乎同时挖到了两个不同的区块。为了便于跟踪这个分叉事件，我们设定有一个被标记为红色的、来自加拿大的区块，还有一个被标记为绿色的、来自澳大利亚的区块。</p>
<p>假设有这样一种情况，一个在加拿大的矿工发现了“红色”区块的工作量证明解，在“蓝色”的父区块上延长了块链。几乎同一时刻，一个澳大利亚的矿工找到了“绿色”区块的解，也延长了“蓝色”区块。那么现在我们就有了两个区块：一个是源于加拿大的“红色”区块；另一个是源于澳大利亚的“绿色”。这两个区块都是有效的，均包含有效的工作量证明解并延长同一个父区块。这个两个区块可能包含了几乎相同的交易，只是在交易的排序上有些许不同。</p>
<p><strong>分叉导致网络分裂</strong><br><img src="http://qiniu.gafata.com/2017-08-03-160930.jpg?imageView2/2/w/800" alt=""><br>比特币网络中邻近（网络拓扑上的邻近，而非地理上的）加拿大的节点会首先收到“红色”区块，并建立一个最大累计难度的区块，“红色”区块为这个链的最后一个区块（蓝色-红色），同时忽略晚一些到达的“绿色”区块。相比之下，离澳大利亚更近的节点会判定“绿色”区块胜出，并以它为最后一个区块来延长区块链（蓝色-绿色），忽略晚几秒到达的“红色”区块。那些首先收到“红色”区块的节点，会即刻以这个区块为父区块来产生新的候选区块，并尝试寻找这个候选区块的工作量证明解。同样地，接受“绿色”区块的节点会以这个区块为链的顶点开始生成新块，延长这个链。</p>
<p><strong>新区块延长了分支</strong><br><img src="http://qiniu.gafata.com/2017-08-03-161200.jpg?imageView2/2/w/800" alt=""><br>分叉问题几乎总是在一个区块内就被解决了。网络中的一部分算力专注于“红色”区块为父区块，在其之上建立新的区块；另一部分算力则专注在“绿色”区块上。即便算力在这两个阵营中平均分配，也总有一个阵营抢在另一个阵营前发现工作量证明解并将其传播出去。在这个例子中我们可以打个比方，假如工作在“绿色”区块上的矿工找到了一个“粉色”区块延长了区块链(蓝色-绿色-粉色)，他们会立刻传播这个新区块，整个网络会都会认为这个区块是有效的，如上图所示。</p>
<p><strong>重新共识</strong><br><img src="http://qiniu.gafata.com/2017-08-03-161338.jpg?imageView2/2/w/800" alt=""><br>所有在上一轮选择“绿色”区块为胜出者的节点会直接将这条链延长一个区块。然而，那些选择“红色”区块为胜出者的节点现在会看到两个链：<strong>“蓝色-绿色-粉色”</strong>和<strong>“蓝色-红色”</strong>。如上图所示，这些节点会根据结果将<strong>“蓝色-绿色-粉色”</strong>这条链设置为主链，将<strong>“蓝色-红色”</strong>这条链设置为备用链。<strong>这些节点接纳了新的更长的链，被迫改变了原有对区块链的观点，这就叫做链的重新共识。</strong>因为“红”区块做为父区块已经不在最长链上，导致了他们的候选区块已经成为了“孤块”，所以现在任何原本想要在“蓝色-红色”链上延长区块链的矿工都会停下来。全网将<strong>“蓝色-绿色-粉色”</strong>这条链识别为主链，“粉色”区块为这条链的最后一个区块。全部矿工立刻将他们产生的候选区块的父区块切换为“粉色”，来延长“蓝色-绿色-粉色”这条链。</p>
<p>从理论上来说，两个区块的分叉是有可能的，这种情况发生在因先前分叉而相互对立起来的矿工，又几乎同时发现了两个不同区块的解。然而，这种情况发生的几率是很低的。单区块分叉每周都会发生，而双块分叉则非常罕见。</p>
<p><strong>比特币将区块间隔设计为10分钟，是在更快速的交易确认和更低的分叉概率间作出的妥协。更短的区块产生间隔会让交易清算更快地完成，也会导致更加频繁地区块链分叉。与之相对地，更长的间隔会减少分叉数量，却会导致更长的清算时间。</strong></p>
<p>参考：<br><a href="http://8btc.com/article-4381-1.html" target="_blank" rel="external">http://8btc.com/article-4381-1.html</a> 什么是UTXO<br><a href="http://blog.csdn.net/wo541075754/article/details/54668121" target="_blank" rel="external">http://blog.csdn.net/wo541075754/article/details/54668121</a> merkle tree在区块链中的应用</p>

      
    </div>
    <footer>
      
        
  
  <div class="categories">
    <a href="/categories/区块链/">区块链</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/比特币/">比特币</a>
  </div>

        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


    
    <div class="links">
        <div class="links_title">推荐阅读</div>
    
            <li ><a href="/2017/08/15/what-is-gafata/" title="据GAFATA理论获利64%">据GAFATA理论获利64%</a></li>
       
            <li ><a href="/2017/08/09/first-half-year-2017/" title="致已经逝去的2017上半年">致已经逝去的2017上半年</a></li>
       
            <li ><a href="/2017/08/05/knowledge-list-july/" title="成为巴菲特、第一性原理、区块链 - 7月份知识清单">成为巴菲特、第一性原理、区块链 - 7月份知识清单</a></li>
       
            <li ><a href="/2017/07/22/find-niche-market/" title="雷达探测，4种方式找到你的小众市场">雷达探测，4种方式找到你的小众市场</a></li>
       
    </div>
    



<section id="comment">
    <div id="gitalk-container"></div>
    <!--<div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div>-->
    <!--<script src="https://img1.cache.netease.com/f2e/tie/yun/sdk/loader.js"></script>-->
    <!--<script>-->
        <!--var cloudTieConfig = {-->
            <!--url: document.location.href,-->
            <!--sourceId: "",-->
            <!--productKey: "a65a1e5ea58d4c3a8ea1fef77d0371db",-->
            <!--target: "cloud-tie-wrapper"-->
        <!--};-->
        <!--var yunManualLoad = true;-->
        <!--Tie.loader("aHR0cHM6Ly9hcGkuZ2VudGllLjE2My5jb20vcGMvbGl2ZXNjcmlwdC5odG1s", true);-->
    <!--</script>-->
    <!--PC和WAP自适应版-->
    <!--<div id="SOHUCS" ></div>-->
    <!--<script type="text/javascript">-->
        <!--(function(){-->
            <!--var appid = 'cyt6v35LM';-->
            <!--var conf = 'prod_82a0b7686345b309fbcbcae5ae75c45e';-->
            <!--var width = window.innerWidth || document.documentElement.clientWidth;-->
            <!--if (width < 960) {-->
                <!--window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="http://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf + '"><\/script>'); } else { var loadJs=function(d,a){var c=document.getElementsByTagName("head")[0]||document.head||document.documentElement;var b=document.createElement("script");b.setAttribute("type","text/javascript");b.setAttribute("charset","UTF-8");b.setAttribute("src",d);if(typeof a==="function"){if(window.attachEvent){b.onreadystatechange=function(){var e=b.readyState;if(e==="loaded"||e==="complete"){b.onreadystatechange=null;a()}}}else{b.onload=a}}c.appendChild(b)};loadJs("http://changyan.sohu.com/upload/changyan.js",function(){window.changyan.api.config({appid:appid,conf:conf})}); } })(); </script>-->

</section>
<!--<script src="/js/gitment.browser.js"></script>-->
<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

<script>
    // const gitment = new Gitment({
    //     owner: 'ljinkai',
    //     repo: 'ljinkai.github.io',
    //     oauth: {
    //         client_id: '1e0bbf087995295c53aa',
    //         client_secret: '7aaf0001f26a5f16ddd7769384d549f317244720',
    //     }
    // })
    // gitment.render('comment')

    const gitalk = new Gitalk({
        clientID: '1e0bbf087995295c53aa',
        clientSecret: '7aaf0001f26a5f16ddd7769384d549f317244720',
        repo: 'ljinkai.github.io',
        owner: 'ljinkai',
        admin: ['ljinkai'],
        id: location.pathname,      // Ensure uniqueness and length less than 50
        distractionFreeMode: false  // Facebook-like distraction free mode
    })

    gitalk.render('gitalk-container')

</script>





</div>
    </div>
    <aside id="sidebar" class="alignright">
  <div class="widget tag" style="padding: 16px;">

      <div style="color: black;font-size: 16px;">
          <div style="width: 100%;text-align: center;margin-bottom: 10px;margin-top: 0px;">我的知识星球</div>
          
          <a style="width: 100%;display: block;text-decoration: none;" href="https://mp.weixin.qq.com/s/LIzhjGGRqiqYnMhIxtFYAw" target="_blank"
             onclick="ga('send', 'event', 'zsxq_11_blog', 'zsxq');">
              <img src="https://qiniu.gafata.com/zsxq.jpeg" width="100%"/>
          </a>
          <div style="width: 100%;text-align: center;margin-bottom: 10px;margin-top: 0px;">我的在线课程</div>
          <a style="width: 100%;display: block;text-decoration: none;" href="https://m.qlchat.com/wechat/page/channel-intro?channelId=2000018572922685" target="_blank"
             onclick="ga('send', 'event', 'my_course', 'live_20170720');">
              <img src="https://qiniu.gafata.com/chrome-extension-qianliao-2.png" width="100%"/>
          </a>
      </div>
</div>


  <div class="widget tag about_fix_none" id="about_fix">

  <ul class="entry" style="text-align: center;font-size: 14px;font-weight: bold;">
    <li>微信公众号：凯凯而谈</li>
    <li style="font-weight: normal;font-size: 12px;">这里有我的分享和思考，我们一起知道做到</li>
    <li><img src='http://qiniu.gafata.com/2019-03-17-web-bear.jpg?imageView2/2/w/600' width='180px' style="margin: 0px auto;display: block;"></li>
  </ul>
</div>
<div class="widget tag">
  <div class="about_banner">
    <div class="about_profile">
      <a href="/2015/02/28/new/">
        <img class="about_img" src="http://qiniu.gafata.com/2019-03-25-WechatIMG1128.jpeg?imageView2/2/w/200">
      </a>
    </div>
  </div>
  <ul class="entry" style="text-align: center;">
    <li>认知、技术、变现</li>
    <li>微博：<a href="http://weibo.com/jieyingbei" target="_blank" onclick="ga('send', 'event', 'widget_about', 'weibo')">@凯凯刘</a></li>
    <li>微信公众号：凯凯而谈</li>
    <li><img src='http://qiniu.gafata.com/2019-03-17-web-bear.jpg?imageView2/2/w/600' width='160px' style="margin: 0px auto;display: block;"></li>
    <li>Web、Indie Maker</li>
  </ul>
  <script>
    function getPageTopLeft(el) {
      var rect = el.getBoundingClientRect();
      var docEl = document.documentElement;
      return {
        left: rect.left + (window.pageXOffset || docEl.scrollLeft || 0),
        top: rect.top + (window.pageYOffset || docEl.scrollTop || 0)
      };
    }
    // window.addEventListener('scroll',function() {
    //   var winWid = document.body.clientWidth;
    //   if (winWid > 900) {
    //     var anchorTop = getPageTopLeft(document.getElementById("anchorTop")).top;
    //     var scrollTop = window.pageYOffset|| document.documentElement.scrollTop || document.body.scrollTop;

    //     if (anchorTop < scrollTop) {
    //       document.getElementById("about_fix").className = "widget tag about_fix";
    //     } else {
    //       document.getElementById("about_fix").className = "widget tag about_fix_none";
    //     }
    //   }
    // });
  </script>
</div>


  
<div class="widget tag">
  <h3 class="title">分类</h3>
  <ul class="entry">
  
    <li><a href="/categories/Indie-Maker/" onclick="ga('send', 'event', 'widget_category', 'Indie Maker');">Indie Maker</a><small>20</small></li>
  
    <li><a href="/categories/Shopify/" onclick="ga('send', 'event', 'widget_category', 'Shopify');">Shopify</a><small>1</small></li>
  
    <li><a href="/categories/Web工具/" onclick="ga('send', 'event', 'widget_category', 'Web工具');">Web工具</a><small>19</small></li>
  
    <li><a href="/categories/Web技术/" onclick="ga('send', 'event', 'widget_category', 'Web技术');">Web技术</a><small>51</small></li>
  
    <li><a href="/categories/产品/" onclick="ga('send', 'event', 'widget_category', '产品');">产品</a><small>6</small></li>
  
    <li><a href="/categories/区块链/" onclick="ga('send', 'event', 'widget_category', '区块链');">区块链</a><small>8</small></li>
  
    <li><a href="/categories/变现/" onclick="ga('send', 'event', 'widget_category', '变现');">变现</a><small>12</small></li>
  
    <li><a href="/categories/工具/" onclick="ga('send', 'event', 'widget_category', '工具');">工具</a><small>3</small></li>
  
    <li><a href="/categories/极客番茄/" onclick="ga('send', 'event', 'widget_category', '极客番茄');">极客番茄</a><small>7</small></li>
  
    <li><a href="/categories/流量/" onclick="ga('send', 'event', 'widget_category', '流量');">流量</a><small>3</small></li>
  
    <li><a href="/categories/浏览器扩展插件/" onclick="ga('send', 'event', 'widget_category', '浏览器扩展插件');">浏览器扩展插件</a><small>3</small></li>
  
    <li><a href="/categories/清单/" onclick="ga('send', 'event', 'widget_category', '清单');">清单</a><small>3</small></li>
  
    <li><a href="/categories/生活/" onclick="ga('send', 'event', 'widget_category', '生活');">生活</a><small>9</small></li>
  
    <li><a href="/categories/直播/" onclick="ga('send', 'event', 'widget_category', '直播');">直播</a><small>1</small></li>
  
    <li><a href="/categories/认知/" onclick="ga('send', 'event', 'widget_category', '认知');">认知</a><small>15</small></li>
  
    <li><a href="/categories/训练营/" onclick="ga('send', 'event', 'widget_category', '训练营');">训练营</a><small>1</small></li>
  
    <li><a href="/categories/读书/" onclick="ga('send', 'event', 'widget_category', '读书');">读书</a><small>4</small></li>
  
    <li><a href="/categories/课程/" onclick="ga('send', 'event', 'widget_category', '课程');">课程</a><small>3</small></li>
  
  </ul>
</div>


  
<div class="widget tag">
  <h3 class="title">标签</h3>
  <ul class="entry">
  
    <li><a href="/tags/CSS3/">CSS3</a><small>4</small></li>
  
    <li><a href="/tags/Chrome/">Chrome</a><small>7</small></li>
  
    <li><a href="/tags/EOS/">EOS</a><small>1</small></li>
  
    <li><a href="/tags/ETH/">ETH</a><small>1</small></li>
  
    <li><a href="/tags/Facebook/">Facebook</a><small>1</small></li>
  
    <li><a href="/tags/Google/">Google</a><small>8</small></li>
  
    <li><a href="/tags/HTML5/">HTML5</a><small>15</small></li>
  
    <li><a href="/tags/HTTPS/">HTTPS</a><small>2</small></li>
  
    <li><a href="/tags/Hybrid-App/">Hybrid App</a><small>2</small></li>
  
    <li><a href="/tags/Indie-Maker/">Indie Maker</a><small>20</small></li>
  
    <li><a href="/tags/JavaScript/">JavaScript</a><small>12</small></li>
  
    <li><a href="/tags/Markdown/">Markdown</a><small>1</small></li>
  
    <li><a href="/tags/Node-js/">Node.js</a><small>2</small></li>
  
    <li><a href="/tags/PWA/">PWA</a><small>1</small></li>
  
    <li><a href="/tags/Shopify/">Shopify</a><small>1</small></li>
  
    <li><a href="/tags/github/">github</a><small>2</small></li>
  
    <li><a href="/tags/临界知识/">临界知识</a><small>1</small></li>
  
    <li><a href="/tags/产品/">产品</a><small>7</small></li>
  
    <li><a href="/tags/人工智能/">人工智能</a><small>2</small></li>
  
    <li><a href="/tags/健康/">健康</a><small>2</small></li>
  
    <li><a href="/tags/增长/">增长</a><small>7</small></li>
  
    <li><a href="/tags/工具/">工具</a><small>15</small></li>
  
    <li><a href="/tags/插件/">插件</a><small>9</small></li>
  
    <li><a href="/tags/方法论/">方法论</a><small>20</small></li>
  
    <li><a href="/tags/木匠/">木匠</a><small>2</small></li>
  
    <li><a href="/tags/极客番茄/">极客番茄</a><small>7</small></li>
  
    <li><a href="/tags/框架/">框架</a><small>6</small></li>
  
    <li><a href="/tags/案例/">案例</a><small>2</small></li>
  
    <li><a href="/tags/概念/">概念</a><small>3</small></li>
  
    <li><a href="/tags/比特币/">比特币</a><small>3</small></li>
  
    <li><a href="/tags/浏览器扩展插件/">浏览器扩展插件</a><small>3</small></li>
  
    <li><a href="/tags/游戏/">游戏</a><small>2</small></li>
  
    <li><a href="/tags/认知/">认知</a><small>7</small></li>
  
    <li><a href="/tags/训练营/">训练营</a><small>1</small></li>
  
    <li><a href="/tags/课程/">课程</a><small>3</small></li>
  
    <li><a href="/tags/资源/">资源</a><small>9</small></li>
  
    <li><a href="/tags/路线图/">路线图</a><small>2</small></li>
  
    <li><a href="/tags/面试题/">面试题</a><small>1</small></li>
  
  </ul>
</div>


  <div class="widget hot">
  <h3 class="title">热文推荐</h3>
  <ul class="entry">
    <li><a href="/2017/06/01/start-small-stay-small/" title="《Start Small, Stay Small》着眼小众市场，程序员的微型创业项目指南">《Start Small, Stay Small》着眼小众市场，程序员的微型创业项目指南</a></li>
    <li><a href="/2017/02/08/how-to-read-a-book/" title="怎样读一本书V5.0 ?(译)">怎样读一本书V5.0 ?(译)</a></li>
    <li><a href="/2015/06/06/mobile-web-skill/" title="移动端web开发技巧">移动端web开发技巧</a></li>
    <li><a href="/2017/12/09/gafata-online/" title="www.gafata.com上线">www.gafata.com上线</a></li>
    <li><a href="/2017/04/19/deliberate-practice/" title="刻意练习">刻意练习</a></li>
    <li><a href="/2016/04/27/progressive-web-app/" title="Web新技术：PWA-Progressive Web App">Web新技术：PWA-Progressive Web App</a></li>
    <li><a href="/2017/08/16/bitcoin-mining-consensus/" title="比特币的挖矿与共识">比特币的挖矿与共识</a></li>
  </ul>
</div>


  <div class="widget tag" style="width:270px;border-top: 0px red solid;line-height: 0px;">

</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2015-2023 <a href="/2015/02/28/new/">凯凯刘</a>
  
  &nbsp;
  <a href="http://www.ezindie.com/" target="_blank" title="Easy Indie">Ezindie</a>
  <a href="http://www.qunheying.com" target="_blank" title="微信群合影" style="margin-left: 10px">微信群合影</a>
  <a href="http://md2vid.com" target="_blank" title="Markdown转视频" style="margin-left: 10px">Markdown转视频</a>
  &nbsp;&nbsp;&nbsp;&nbsp;
  <a href="/atom.xml" class="menu_rss menu_rss_bottom" target="_blank" title="RSS订阅"></a>
  &nbsp;&nbsp;&nbsp;&nbsp;
  Powered by <a href="http://hexo.io/">Hexo</a>
</div>
<div class="clearfix"></div>

<!--<script>-->
    <!--var _hmt = _hmt || [];-->
    <!--(function() {-->
        <!--var hm = document.createElement("script");-->
        <!--hm.src = "//hm.baidu.com/hm.js?1e92fed8a761c1224623815e3b960447";-->
        <!--var s = document.getElementsByTagName("script")[0];-->
        <!--s.parentNode.insertBefore(hm, s);-->
    <!--})();-->
<!--</script>-->
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-85358197-2', 'auto');
    ga('send', 'pageview');

</script>


</footer>
  <!--<script src="http://apps.bdimg.com/libs/jquery/2.1.1/jquery.min.js"></script>-->
<!--<script src="<- config.root >js/jquery.imagesloaded.min.js"></script>-->
<!--<script src="<- config.root >js/gallery.js"></script>-->




</body>
</html>